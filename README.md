# The ad counter API

The Ad Counter API — это сервис JSON API, 
предназначенный для отслеживания количества объявлений на сайте Cian.ru по количеству комнат в квартире и региону. 
Пользователи могут задать комбинацию количества комнат и региона для мониторинга, 
после чего сервис будет периодически запрашивать данные с Cian.ru, 
обновлять количество объявлений и предоставлять топ-5 объявлений по выбранным критериям.

Этот сервис использует асинхронную обработку с помощью Celery, хранит данные во внешнем хранилище PostgreSQL, 
контейнеризованном с использованием Docker, и использует Redis в качестве брокера сообщений. 
Для более точного получения данных используется Selenium, который имитирует запросы пользователя через браузер.

## Оглавление

- [Возможности](#возможности)
- [Установка и использование](#установка-и-использование)
- [Структура проекта](#структура-проекта)
- [API Эндпоинты](#api-эндпоинты)
- [Docker](#docker)
- [Тестирование](#тестирование)
- [Документация](#документация)
- [Celery](#celery)

## Возможности

- **Создание и отслеживание объявлений**: Определение комбинаций количества комнат и региона для мониторинга объявлений на Cian.ru.
- **Асинхронная обработка**: Использует Celery для обработки запросов и задач в фоновом режиме.
- **Хранение данных**: Все данные хранятся в базе данных PostgreSQL, контейнеризированной для удобного развертывания.
- **Топ-5 объявлений**: Получение топ-5 объявлений для любой заданной комбинации количества комнат и региона.
- **Планирование задач**: Сервис автоматически обновляет количество объявлений каждый час для активных запросов.
- **Имитация запросов**: Использует Selenium для имитации поведения пользователя и получения данных с Cian.ru, как это сделал бы реальный браузер.
- **Документация API**: Интегрирован с Swagger для предоставления подробной документации API.

## Установка и использование

### Предварительные требования
- Установленные Docker и Docker Compose
- Python версии 3.11

### Шаги установки

1. Клонируйте репозиторий:
    ```sh
    git clone https://github.com/RedHotChilliHead/The_ad_counter.git
    cd The_ad_counter
    ```

2. Установите зависимости:
    ```sh
    pip install -r requirements.txt
    ```

3. Создайте том для сохранения данных приложения:
    ```sh
    docker volume create counter_postgres_data
    ```

4. Запуск всех контейнеров в режиме демона:
    ```sh
    docker compose up -d
    ```

5. Примените миграции:
    ```sh
    docker compose run counterapp python manage.py migrate
    ```

Сервер будет доступен по адресу `http://127.0.0.1:8000`.

## Структура проекта

- **urls.py** (корневой): Конфигурация маршрутизации URL проекта, включая маршруты для административного интерфейса и
  API-документации.

- **urls.py** (приложение): Конфигурация маршрутизации URL для приложения, 
включая создание связок количества комнат и региона, отображение статистики и топ-5 объявлений.

- **models.py**: Определения моделей связки, счетчика и объявления.

- **views.py**: Определения представлений для обработки запросов к API, включая создание связки количества
  комант + регион, отображение счетчиков по заданным параметрам и топ-5 объявлений по заданному id-связки.

- **serializers.py**: Сеарелизаторы счетчиков и объявлений.

- **tasks.py**: Задачи по выполнению запросов к Циан и парсингу страниц, выполняемые Celery.
Реализовано логирование, для отслеживания состояния задач.

- **tests.py**: Тесты для API приложения.

## API Эндпоинты

#### Метод создания связки для поиска на Cian.ru по количеству комнат и региону

Данный метод API принимает количество комнат в квартире и наименование региона, регистирует связку в системе
и возвращает ее ID.
Наименование региона или города необходимо вводить поле 'region' на английском языке с заглавными или прописными
буквами.
Если наименование региона указывается некорректно, будет возвращено сообщение об ошибке.
В поле 'phrase' указывается количество комнат, возможные варианты: 1,2,3,4,5,6,studio,free.
Цифры 1-6 соответствуют количеству комнат в квартире, 'studio' для поиска квартиры-студии,
'free' используется для поиска квартиры со свободной планировкой или можно оставить пустое поле для поиска 1 или
2х-комнатной квартиры.

Примечание:
После регистрации связки в системе происходит асинхронное выполнение задачи по запросу информации с Cian.ru,
парсинг страницы, создание счетчиков с количеством объявлений на текущий момент.
Также записываются топ-5 объявлений для данной связки. 
Планировщик задач обновляет информацию раз в час.

#### URL

```plaintext
http://127.0.0.1:8000/counter/add/
```

#### Пример запроса

```plaintext
POST
Content-Type: application/json

Body: {
    "phrase": "studio",
    "region": "Nizhniy Novgorod"
}
```

#### Пример ответа

```plaintext
HTTP 201 Created
Allow: POST, OPTIONS
Content-Type: application/json
Vary: Accept

{
    "id": 1
}
```

#### Метод отображения счетчиков по заданному запросу

Данный метод API принимает id-связки и временной интервал, за который нужно вывести счётчики.
Параметры id и start_time являются обязательными, тогда как end_time может быть опущен, в таком случае
будут выведены все счетчики начиная со start_time, заканчивая текущей датой.
Возвращает количество объявлений и соответствующие им временные метки.
API метод отображает количество объявлений по заданному запросу.

#### URL

```plaintext
http://127.0.0.1:8000/counter/stat/?id=<id>&start_time=<start_time>&end_time=<end_time>
```

#### Пример запроса

```http
GET http://127.0.0.1:8000/counter/stat/?id=1&start_time=2024-01-01&end_time=2024-08-10
```

#### Пример ответа

```plaintext
HTTP 200 OK
Allow: GET, HEAD, OPTIONS
Content-Type: application/json
Vary: Accept

[
    {
        "id": 30,
        "count": 5637,
        "date": "2024-08-08T08:50:52.476252Z"
    },
    {
        "id": 40,
        "count": 5633,
        "date": "2024-08-08T09:50:34.570090Z"
    }
]
```

#### Метод отображения топ-5 объявлений по заданному запросу

Данный метод API принимает id-связки и возвращает топ-5 объявлений по заданному запросу.
А конкретно id объявления, его место в рейтинге и саму ссылку на объявление.
Частота обновления топа также составляет 1 раз в час для каждого id связки.

#### URL

```plaintext
http://127.0.0.1:8000/counter/top/?id=<id>
```

#### Пример запроса

```http
GET http://127.0.0.1:8000/counter/top/?id=1
```

#### Пример ответа

```plaintext
HTTP 200 OK
Allow: GET, HEAD, OPTIONS
Content-Type: application/json
Vary: Accept

[
    {
        "id": 6,
        "top": 1,
        "link": "https://nn.cian.ru/sale/flat/301900691/"
    },
    {
        "id": 7,
        "top": 2,
        "link": "https://nn.cian.ru/sale/flat/304157423/"
    },
    {
        "id": 8,
        "top": 3,
        "link": "https://nn.cian.ru/sale/flat/295730930/"
    },
    {
        "id": 9,
        "top": 4,
        "link": "https://nn.cian.ru/sale/flat/297175017/"
    },
    {
        "id": 10,
        "top": 5,
        "link": "https://nn.cian.ru/sale/flat/303468898/"
    }
]
```

#### Во всех методах реализована валидация полей

## Docker

Проект использует Docker для контейнеризации. Дополнительные команды:

- Запуск всех контейнеров с пересборкой:

    ```sh
    docker compose up -d --build
    ```

- Остановка всех контейнеров:

    ```sh
    docker compose down
    ```

- Удаление тома:

  ```sh
  docker volume rm counter_postgres_data
  ```

## Тестирование

Проект содержит тесты для проверки функциональности API.
Что бы ошибки в асинхронных задачах выбрасывались сразу и что бы корректно выполнить тестирование, 
необходимо в файле /The_ad_counter/The_ad_counter/The_ad_counter/settings.py раскомментировать строки

```
CELERY_TASK_ALWAYS_EAGER = True
CELERY_TASK_EAGER_PROPAGATES = True
```

После чего запустить тесты следующими командами:

```sh
TEST_MODE=True docker compose up -d
docker compose exec counterapp python manage.py test
```

Покрытие тестами составляет 93%, что бы проверить необходимо выполнить следующие команды:

```sh
TEST_MODE=True docker compose up -d
docker compose exec counterapp coverage run manage.py test
docker compose exec counterapp coverage report
```

## Документация

К данному API подключена Swagger документация на английском языке и она доступна по адресу
http://127.0.0.1:8000/api/schema/swagger/

## Celery

Проект использует Celery для выполнения задач по запросу к Циану.
(Не обязательно) Основные команды для управления и мониторинга:

- Проверка состояния воркеров

```sh
celery -A The_ad_counter status
```

- Выключение воркера

```sh
celery -A The_ad_counter control shutdown
```

- Проверка выполняемых задач

```sh
celery -A The_ad_counter inspect active
```

- Проверка завершенных задач

```sh
celery -A The_ad_counter inspect reserved
```

- Получение списка активных очередей

```sh
celery -A The_ad_counter inspect active_queues
```