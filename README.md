# The ad counter API

Этот проект представляет собой JSON API сервис, позволяющий следить за изменением количества объявлений на Циане по
количеству комнат в квартире и региону.
Вы можете задать связку: количество комнат и регион, после чего следить за количеством объявлений.
Раз в час Циан будет опрашиваться, создадутся счетчики, Вы сможете их посмотреть, а также отобразить топ-5 объявлений по
данному запросу.
Сервис асинхронно обрабатывает запросы с помощью Celery.
Данные сервиса хранятся во внешнем хранилище Postgres, который запускается через docker-compose.
В качестве брокера используется сервер Redis.

## Оглавление

- [Установка и использование](#установка-и-использование)
- [Структура проекта](#структура-проекта)
- [API Эндпоинты](#api-эндпоинты)
- [Docker](#docker)
- [Тестирование](#тестирование)
- [Документация](#документация)
- [Celery](#celery)

## Установка и использование

1. Клонируйте репозиторий:
    ```sh
    git clone https://github.com/RedHotChilliHead/The_ad_counter.git
    cd The_ad_counter
    ```

2. Установите зависимости:
    ```sh
    pip install -r requirements.txt
    ```

3. Создайте том для сохранения данных приложения:
    ```sh
    docker volume create counter_postgres_data
    ```

4. Запуск всех контейнеров в режиме демона:
    ```sh
    docker-compose up -d
    ```

5. Примените миграции:
    ```sh
    docker-compose run counterapp python manage.py migrate
    ```

Сервер будет доступен по адресу `http://127.0.0.1:8000`.

## Структура проекта

- urls.py (корневой): Конфигурация маршрутизации URL проекта, включая маршруты для административного интерфейса и
  API-документации.

- urls.py (приложение): Конфигурация маршрутизации URL для приложения, включая включая создание связки количества
  комант + регион, отображение статистики и топ-5 объявлений.

- models.py: Определения моделей связки, счетчика и объявления.

- views.py: Определения представлений для обработки запросов к API, включая создание связки количества
  комант + регион, отображение счетчиков по заданным параметрам и топ-5 объявлений по заданному id-связки.

- serializers.py: Сеарелизаторы счетчиков и объявлений.

- tasks.py:  Задачи по выполнению запросов к Циан и парсингу страниц, выполняемые Celery.
Реализовано логирование, для отслеживания состояния задач.

- tests.py: Тесты для API приложения.

## API Эндпоинты

#### Метод сохранения связки, для поиска на Циане по количеству квартир и региону

Данный метод API принимает количество комнат в квартире и наименование региона, регистирует связку в системе
и вовзвращает ее ID.
Наименование региона или города необходимо вводить поле 'region' на английском языке с заглавными или прописными
буквами.
Если наименование региона указывается некорректно, будет возвращено сообщение об ошибке.
В поле 'phrase' указывается количество комнат, возможные варианты: 1,2,3,4,5,6,studio,free.
Цифры 1-6 соответствуют количеству комнат в квартире, 'studio' для поиска квартиры-студии,
'free' используется для поиска квартиры со свободной планировкой или можно оставить пустое поле для поиска 1 или
2х-комнатной квартиры.

Примечание:
После регистрации связки в системе происходит асинхронное выполнение задачи по запросу информации на Циане,
парсинг страницы, создание счетчиков с количеством объявлений на текущий момент,
а также запись в базу данных топ-5 объявлений по данной связке.
В дальнейшем планировщик задач раз в час ищет связки, по которым не создавался счетчик объявлений более часа и
ставит в очередь задачи для асинхронного выполнения.

#### URL

```plaintext
http://127.0.0.1:8000/counter/add/
```

#### Пример запроса

```plaintext
POST
Content-Type: application/json

Body: {
    "phrase": "studio",
    "region": "Nizhniy Novgorod"
}
```

#### Пример ответа

```plaintext
HTTP 201 Created
Allow: POST, OPTIONS
Content-Type: application/json
Vary: Accept

{
    "id": 1
}
```

#### Метод отображения счетчиков по заданному запросу

Данный метод API принимает id-связки и временной интервал, за который нужно вывести счётчики.
Параметры id и start_time являются обязательными, тогда как end_time может быть опущен, в таком случае
будут выведены все счетчики начиная со start_time, заканчивая текущей датой.
Возвращает количество объявлений и соответствующие им временные метки.
API метод отображает количество объявлений по заданному запросу.

#### URL

```plaintext
http://127.0.0.1:8000/counter/stat/?id=<id>&start_time=<start_time>&end_time=<end_time>
```

#### Пример запроса

```http
GET http://127.0.0.1:8000/counter/stat/?id=1&start_time=2024-01-01&end_time=2024-08-10
```

#### Пример ответа

```plaintext
HTTP 200 OK
Allow: GET, HEAD, OPTIONS
Content-Type: application/json
Vary: Accept

[
    {
        "id": 30,
        "count": 5637,
        "date": "2024-08-08T08:50:52.476252Z"
    },
    {
        "id": 40,
        "count": 5633,
        "date": "2024-08-08T09:50:34.570090Z"
    }
]
```

#### Метод отображения топ-5 объявлений по заданному запросу

Данный метод API принимает id-связки и возвращает топ-5 объявлений по заданному запросу.
А конкретно id объявления, его место в рейтинге и саму ссылку на объявление.
Частота обновления топа также составляет 1 раз в час для каждого id связки.

#### URL

```plaintext
http://127.0.0.1:8000/counter/top/?id=<id>
```

#### Пример запроса

```http
GET http://127.0.0.1:8000/counter/top/?id=1
```

#### Пример ответа

```plaintext
HTTP 200 OK
Allow: GET, HEAD, OPTIONS
Content-Type: application/json
Vary: Accept

[
    {
        "id": 6,
        "top": 1,
        "link": "https://nn.cian.ru/sale/flat/301900691/"
    },
    {
        "id": 7,
        "top": 2,
        "link": "https://nn.cian.ru/sale/flat/304157423/"
    },
    {
        "id": 8,
        "top": 3,
        "link": "https://nn.cian.ru/sale/flat/295730930/"
    },
    {
        "id": 9,
        "top": 4,
        "link": "https://nn.cian.ru/sale/flat/297175017/"
    },
    {
        "id": 10,
        "top": 5,
        "link": "https://nn.cian.ru/sale/flat/303468898/"
    }
]
```

#### Во всех методах реализована валидация полей

## Docker

Проект использует Docker для контейнеризации. Основные команды:

- Запуск всех контейнеров в режиме демона:

    ```sh
    docker-compose up -d
    ```

- Запуск всех контейнеров с пересборкой:

    ```sh
    docker-compose up -d --build
    ```

- Остановка всех контейнеров:

    ```sh
    docker-compose down
    ```
- Создание тома:

  ```sh
  docker volume create counter_postgres_data
  ```
- Удаление тома:

  ```sh
  docker volume rm counter_postgres_data
  ```

- Применение миграций:

    ```sh
    docker-compose run counterapp python manage.py migrate
    ```

## Тестирование

Проект содержит тесты для проверки функциональности API.
Что бы ошибки в асинхронных задачах выбрасывались сразу и что бы корректно выполнить тестирование, 
необходимо в файле /The_ad_counter/The_ad_counter/The_ad_counter/settings.py раскомментировать строки

```
CELERY_TASK_ALWAYS_EAGER = True
CELERY_TASK_EAGER_PROPAGATES = True
```

После чего запустить тесты следующими командами:

```sh
TEST_MODE=True docker compose up -d
docker compose exec counterapp python manage.py test
```

Покрытие тестами составляет 93%, что бы проверить необходимо выполнить следующие команды:

```sh
TEST_MODE=True docker compose up -d
docker compose exec counterapp coverage run manage.py test
docker compose exec counterapp coverage report
```

## Документация

К данному API подключена Swagger документация на английском языке и она доступна по адресу
http://127.0.0.1:8000/api/schema/swagger/

## Celery

Проект использует Celery для выполнения задач по запросу к Циану.
Основные команды для управления и мониторинга (при желании):

- Проверка состояния воркеров

```sh
celery -A The_ad_counter status
```

- Выключение воркера

```sh
celery -A The_ad_counter control shutdown
```

- Проверка выполняемых задач

```sh
celery -A The_ad_counter inspect active
```

- Проверка завершенных задач

```sh
celery -A The_ad_counter inspect reserved
```

- Получение списка активных очередей

```sh
celery -A The_ad_counter inspect active_queues
```